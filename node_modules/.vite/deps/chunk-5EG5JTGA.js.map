{
  "version": 3,
  "sources": ["../../vanjs-core/src/van.js"],
  "sourcesContent": ["// This file consistently uses `let` keyword instead of `const` for reducing the bundle size.\n\n// Global variables - aliasing some builtin symbols to reduce the bundle size.\nlet protoOf = Object.getPrototypeOf\nlet changedStates, derivedStates, curDeps, curNewDerives, alwaysConnectedDom = {isConnected: 1}\nlet gcCycleInMs = 1000, statesToGc, propSetterCache = {}\nlet objProto = protoOf(alwaysConnectedDom), funcProto = protoOf(protoOf), _undefined\n\nlet addAndScheduleOnFirst = (set, s, f, waitMs) =>\n  (set ?? (setTimeout(f, waitMs), new Set)).add(s)\n\nlet runAndCaptureDeps = (f, deps, arg) => {\n  let prevDeps = curDeps\n  curDeps = deps\n  try {\n    return f(arg)\n  } catch (e) {\n    console.error(e)\n    return arg\n  } finally {\n    curDeps = prevDeps\n  }\n}\n\nlet keepConnected = l => l.filter(b => b._dom?.isConnected)\n\nlet addStatesToGc = d => statesToGc = addAndScheduleOnFirst(statesToGc, d, () => {\n  for (let s of statesToGc)\n    s._bindings = keepConnected(s._bindings),\n    s._listeners = keepConnected(s._listeners)\n  statesToGc = _undefined\n}, gcCycleInMs)\n\nlet stateProto = {\n  get val() {\n    curDeps?._getters?.add(this)\n    return this.rawVal\n  },\n\n  get oldVal() {\n    curDeps?._getters?.add(this)\n    return this._oldVal\n  },\n\n  set val(v) {\n    curDeps?._setters?.add(this)\n    if (v !== this.rawVal) {\n      this.rawVal = v\n      this._bindings.length + this._listeners.length ?\n        (derivedStates?.add(this), changedStates = addAndScheduleOnFirst(changedStates, this, updateDoms)) :\n        this._oldVal = v\n    }\n  },\n}\n\nlet state = initVal => ({\n  __proto__: stateProto,\n  rawVal: initVal,\n  _oldVal: initVal,\n  _bindings: [],\n  _listeners: [],\n})\n\nlet bind = (f, dom) => {\n  let deps = {_getters: new Set, _setters: new Set}, binding = {f}, prevNewDerives = curNewDerives\n  curNewDerives = []\n  let newDom = runAndCaptureDeps(f, deps, dom)\n  newDom = (newDom ?? document).nodeType ? newDom : new Text(newDom)\n  for (let d of deps._getters)\n    deps._setters.has(d) || (addStatesToGc(d), d._bindings.push(binding))\n  for (let l of curNewDerives) l._dom = newDom\n  curNewDerives = prevNewDerives\n  return binding._dom = newDom\n}\n\nlet derive = (f, s = state(), dom) => {\n  let deps = {_getters: new Set, _setters: new Set}, listener = {f, s}\n  listener._dom = dom ?? curNewDerives?.push(listener) ?? alwaysConnectedDom\n  s.val = runAndCaptureDeps(f, deps, s.rawVal)\n  for (let d of deps._getters)\n    deps._setters.has(d) || (addStatesToGc(d), d._listeners.push(listener))\n  return s\n}\n\nlet add = (dom, ...children) => {\n  for (let c of children.flat(Infinity)) {\n    let protoOfC = protoOf(c ?? 0)\n    let child = protoOfC === stateProto ? bind(() => c.val) :\n      protoOfC === funcProto ? bind(c) : c\n    child != _undefined && dom.append(child)\n  }\n  return dom\n}\n\nlet tag = (ns, name, ...args) => {\n  let [{is, ...props}, ...children] = protoOf(args[0] ?? 0) === objProto ? args : [{}, ...args]\n  let dom = ns ? document.createElementNS(ns, name, {is}) : document.createElement(name, {is})\n  for (let [k, v] of Object.entries(props)) {\n    let getPropDescriptor = proto => proto ?\n      Object.getOwnPropertyDescriptor(proto, k) ?? getPropDescriptor(protoOf(proto)) :\n      _undefined\n    let cacheKey = name + \",\" + k\n    let propSetter = propSetterCache[cacheKey] ??= getPropDescriptor(protoOf(dom))?.set ?? 0\n    let setter = k.startsWith(\"on\") ?\n      (v, oldV) => {\n        let event = k.slice(2)\n        dom.removeEventListener(event, oldV)\n        dom.addEventListener(event, v)\n      } :\n      propSetter ? propSetter.bind(dom) : dom.setAttribute.bind(dom, k)\n    let protoOfV = protoOf(v ?? 0)\n    k.startsWith(\"on\") || protoOfV === funcProto && (v = derive(v), protoOfV = stateProto)\n    protoOfV === stateProto ? bind(() => (setter(v.val, v._oldVal), dom)) : setter(v)\n  }\n  return add(dom, children)\n}\n\nlet handler = ns => ({get: (_, name) => tag.bind(_undefined, ns, name)})\n\nlet update = (dom, newDom) => newDom ? newDom !== dom && dom.replaceWith(newDom) : dom.remove()\n\nlet updateDoms = () => {\n  let iter = 0, derivedStatesArray = [...changedStates].filter(s => s.rawVal !== s._oldVal)\n  do {\n    derivedStates = new Set\n    for (let l of new Set(derivedStatesArray.flatMap(s => s._listeners = keepConnected(s._listeners))))\n      derive(l.f, l.s, l._dom), l._dom = _undefined\n  } while (++iter < 100 && (derivedStatesArray = [...derivedStates]).length)\n  let changedStatesArray = [...changedStates].filter(s => s.rawVal !== s._oldVal)\n  changedStates = _undefined\n  for (let b of new Set(changedStatesArray.flatMap(s => s._bindings = keepConnected(s._bindings))))\n    update(b._dom, bind(b.f, b._dom)), b._dom = _undefined\n  for (let s of changedStatesArray) s._oldVal = s.rawVal\n}\n\nexport default {\n  tags: new Proxy(ns => new Proxy(tag, handler(ns)), handler()),\n  hydrate: (dom, f) => update(dom, bind(f, dom)),\n  add, state, derive,\n}\n"],
  "mappings": "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",
  "names": ["v"]
}
